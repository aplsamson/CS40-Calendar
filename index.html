<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CS40 Calendar</title>
    <link rel="icon" href="https://www.aviatorgear.com/images/product/large/39950.jpg" type="image/jpeg">
    
    <style>
        html { font-size: 14px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { background-color: #f4f4f9; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; width: 100%; min-height: 100vh; }
        
        /* TOP LAYOUT */
        .top-container { position: relative; display: flex; justify-content: center; align-items: center; width: 100%; max-width: 1400px; margin-bottom: 30px; min-height: 110px; }
        .main-header { display: flex; align-items: center; background-color: white; padding: 15px 30px; border-radius: 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); z-index: 10; }
        .header-logo { height: 5rem; width: auto; margin-right: 20px; cursor: pointer; }
        .header-title { font-size: 2.5rem; color: #333; font-weight: bold; margin: 0; white-space: nowrap; }
        
        .header-actions-left { position: absolute; left: 0; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: flex-start; gap: 10px; z-index: 20; }
        
        /* HEADER ACTIONS RIGHT */
        .header-actions-right { 
            position: absolute; right: 0; top: 50%; transform: translateY(-50%); 
            display: flex; 
            flex-direction: row; /* Horizontal layout: Filter | Stack */
            align-items: center; /* Center filter button relative to stack */
            gap: 12px; 
            z-index: 20; 
        }

        /* NEW STACK FOR EDIT/ADD BUTTONS */
        .action-buttons-stack {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: flex-end; /* Right align buttons */
        }
        
        .clean-mode-legend { position: absolute; right: 0; top: 50%; transform: translateY(-50%); display: none; background: white; padding: 15px 20px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); gap: 8px; flex-direction: column; align-items: flex-start; z-index: 20; min-width: 120px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; font-weight: bold; color: #555; width: 100%; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }

        .header-btn { border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: background 0.2s, transform 0.1s; white-space: nowrap; width: 160px; text-align: center; }
        .header-btn:active { transform: scale(0.98); }
        .week-view-btn { background-color: #003087; color: white; }
        .week-view-btn:hover { background-color: #001e54; }
        .add-event-btn-main { background-color: #003087; color: white; display: none; }
        .add-event-btn-main:hover { background-color: #001e54; }
        .edit-mode-btn { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; }
        .edit-mode-btn:hover { background-color: #e0e0e0; }
        .edit-mode-btn.active { background-color: #d9534f; color: white; border: none; box-shadow: 0 2px 5px rgba(217, 83, 79, 0.4); }
        
        /* FILTER BUTTON */
        .filter-btn { 
            background-color: white; color: #333; border: 1px solid #ccc; 
            width: 40px; height: 40px; padding: 0;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; 
            cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .filter-btn:hover { background-color: #f0f0f0; }
        .filter-btn svg { width: 20px; height: 20px; fill: #555; }
        .filter-btn.active-filter { border-color: #003087; background-color: #eef4ff; }
        .filter-btn.active-filter svg { fill: #003087; }

        /* CALENDAR */
        .calendar-container { width: 100%; max-width: 1400px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; border-top: 2px solid black; border-left: 2px solid black; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background-color: #003087; color: white; border-right: 2px solid black; border-bottom: 2px solid black; }
        .calendar-header.hidden { display: none; }
        .nav-btn { background: none; border: 1px solid white; color: white; padding: 5px 15px; cursor: pointer; font-size: 1.2rem; border-radius: 4px; }
        .nav-btn:hover { background: rgba(255,255,255,0.2); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; }
        .grid-header-cell { text-align: center; padding: 10px; background-color: #e0e0e0; font-weight: bold; border-right: 2px solid black; border-bottom: 2px solid black; color: #333; }
        
        .day-cell { height: 240px; overflow: hidden; border-right: 2px solid black; border-bottom: 2px solid black; position: relative; display: flex; flex-direction: column; background-color: white; cursor: pointer; transition: background-color 0.1s; }
        .day-cell:hover { background-color: #f0f8ff; }
        .day-cell.week-view { height: auto !important; min-height: 500px; }
        .day-cell.inactive { background-color: #eee; cursor: default; }

        .date-number { position: absolute; top: 5px; left: 8px; font-weight: bold; font-size: 1.1rem; color: #333; z-index: 2; pointer-events: none; }
        .date-number.current-day { color: #ff0000 !important; font-size: 1.2rem; }
        .day-type { position: absolute; top: 5px; width: 100%; text-align: center; font-weight: bold; font-size: 0.95rem; color: #003087; z-index: 2; pointer-events: none; }
        .weekend-label { position: absolute; top: 22px; width: 100%; text-align: center; font-size: 0.8rem; font-weight: bold; color: #666; z-index: 1; pointer-events: none; }

        .day-content { flex: 1; display: flex; flex-direction: column; padding-top: 35px; height: 100%; }
        .day-section { flex: 1; border-bottom: 1px dotted #999; width: 100%; font-size: 0.75rem; padding: 3px 2px; overflow: hidden; position: relative; }
        .day-cell.week-view .day-section { height: auto; flex: 1 0 auto; min-height: 80px; }
        .day-section:last-child { border-bottom: none; }
        .day-section::after { content: attr(data-label); position: absolute; bottom: 2px; right: 4px; font-size: 0.65rem; color: #999; pointer-events: none; opacity: 0.7; font-weight: bold; text-transform: uppercase; }

        .event-chip { display: block; color: white; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.75rem; pointer-events: none; z-index: 5; position: relative; text-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        .day-cell.week-view .event-chip { font-size: 0.9rem; padding: 6px 8px; white-space: normal; line-height: 1.3; margin-bottom: 4px; display: flex; flex-direction: column; }
        .more-events-indicator { font-size: 1.2rem; line-height: 0.5; color: #333; text-align: center; font-weight: bold; padding-bottom: 2px; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 550px; max-width: 90%; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; max-height: 85vh; overflow-y: auto; }
        .close-modal-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; z-index: 10; }
        .modal-title { margin-bottom: 20px; font-size: 1.5rem; color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .time-inputs { display: flex; gap: 10px; }
        .time-inputs input { flex: 1; }
        .checkbox-group { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .checkbox-group label { font-weight: normal; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        
        .modal-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .modal-actions { display: flex; gap: 10px; }
        .mandatory-toggle { display: flex; align-items: center; gap: 8px; font-weight: bold; color: #d9534f; cursor: pointer; }
        .btn-cancel { background: #ccc; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .btn-save { background: #003087; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }

        /* FILTER MODAL SPECIFIC */
        #filterModal .modal-content { width: 400px; }
        #filterModal .modal-footer { margin-top: 30px; }
        .filter-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .filter-section:last-child { border-bottom: none; }
        .filter-section h4 { margin: 0 0 10px 0; color: #003087; }

        /* DAY DETAIL */
        .day-view-header { border-bottom: 2px solid #003087; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .header-text-group { display: flex; flex-direction: column; }
        .day-view-date { font-size: 1.8rem; font-weight: bold; color: #333; }
        .day-view-type { font-size: 1.2rem; color: #003087; font-weight: bold; margin-top: 5px; }
        .day-view-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .day-view-item { background: #f4f4f9; padding: 15px; border-left: 4px solid #003087; border-radius: 4px; display: flex; gap: 20px; }
        .day-view-info { flex: 1; }
        .day-view-notes { flex: 1; border-left: 1px solid #ddd; padding-left: 15px; color: #555; font-size: 0.9rem; white-space: pre-wrap; }
        .day-view-notes strong { display: block; margin-bottom: 5px; color: #333; }
        .day-view-item h4 { margin: 0 0 5px 0; font-size: 1.2rem; color: #003087; }
        .day-view-item p { margin: 0 0 3px 0; font-size: 0.9rem; color: #666; }
        .action-btn-sm { border: none; padding: 8px 12px; font-size: 0.85rem; border-radius: 4px; cursor: pointer; margin-top: 10px; display: none; margin-right: 5px; }
        .edit-btn { background-color: #f0ad4e; color: white; }
        .delete-btn { background-color: #ff4d4f; color: white; }

        /* EDIT CONTROLS */
        .day-view-edit-controls { display: none; flex-direction: column; gap: 5px; align-items: flex-start; margin-right: 35px; }
        #standardControls { display: flex; flex-direction: column; gap: 5px; align-items: flex-start; }
        .toggle-item { font-weight: bold; color: #333; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.95rem; }
        .label-ssoc { color: #003087; }
        .label-noschool { color: #d9534f; }
        .toggle-item input { transform: scale(1.2); cursor: pointer; }
        .day-view-add-btn-rect { background-color: #003087; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; width: 100%; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s; }
        .day-view-add-btn-rect:hover { background-color: #001e54; }
        
        .force-hide { display: none !important; }
        .force-show-flex { display: flex !important; }
    </style>
</head>
<body>

    <div id="pinModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 300px;">
            <h3 class="modal-title">Enter Admin PIN</h3>
            <div class="form-group">
                <input type="password" id="pinInput" class="form-control" placeholder="PIN Code">
            </div>
            <div class="modal-actions">
                <button id="cancelPinBtn" class="btn-cancel">Cancel</button>
                <button id="submitPinBtn" class="btn-save">Unlock</button>
            </div>
        </div>
    </div>

    <div class="top-container">
        <div class="header-actions-left" id="headerActionsLeft"><button id="weekViewBtn" class="header-btn week-view-btn">Week View</button></div>
        <div class="main-header">
            <img src="https://www.aviatorgear.com/images/product/large/39950.jpg" alt="CS40 Logo" class="header-logo" id="mainHeaderLogo" title="Double Click to Toggle Clean Mode">
            <h1 class="header-title" id="mainHeaderTitle">CS40 Calendar</h1>
        </div>
        <div class="header-actions-right" id="headerActionsRight">
            <button id="filterBtn" class="filter-btn" title="Filter Events">
                <svg viewBox="0 0 24 24"><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/></svg>
            </button>
            
            <div class="action-buttons-stack">
                <button id="editModeBtn" class="header-btn edit-mode-btn">Edit Mode</button>
                <button id="addEventBtn" class="header-btn add-event-btn-main">+ Add Event</button>
            </div>
        </div>
        <div class="clean-mode-legend" id="cleanModeLegend">
            <div class="legend-item"><div class="legend-dot" style="background: #d9534f;"></div> 26ers</div>
            <div class="legend-item"><div class="legend-dot" style="background: #FFD700;"></div> 27ers</div>
            <div class="legend-item"><div class="legend-dot" style="background: #003087;"></div> 28ers</div>
            <div class="legend-item"><div class="legend-dot" style="background: #C0C0C0;"></div> 29ers</div>
            <div class="legend-item"><div class="legend-dot" style="background: black;"></div> All</div>
        </div>
    </div>

    <div class="calendar-container">
        <header class="calendar-header" id="calendarNavHeader">
            <button id="prevBtn" class="nav-btn">&lt;</button> <h2 id="monthYear">Month Year</h2> <button id="nextBtn" class="nav-btn">&gt;</button>
        </header>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div id="filterModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">Filter Events</h3>
            <div class="filter-section">
                <h4>By Class</h4>
                <div class="checkbox-group">
                    <label><input type="checkbox" value="26" class="filter-class-check"> 26</label>
                    <label><input type="checkbox" value="27" class="filter-class-check"> 27</label>
                    <label><input type="checkbox" value="28" class="filter-class-check"> 28</label>
                    <label><input type="checkbox" value="29" class="filter-class-check"> 29</label>
                </div>
            </div>
            <div class="filter-section">
                <h4>By Type</h4>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="filterMandatoryCheck"> Mandatory Only</label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="clearFiltersBtn" class="btn-cancel" style="background: #d9534f; color: white;">Clear All</button>
                <button id="closeFilterBtn" class="btn-save">Close</button>
            </div>
        </div>
    </div>

    <div id="eventModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Add Event</h3>
            <div class="form-group"><label>Date</label><input type="date" id="eventDate" class="form-control"></div>
            <div class="form-group"><label>Event Name</label><input type="text" id="eventName" class="form-control" placeholder="e.g. Current Event Briefs"></div>
            <div class="form-group"><label>Location (Optional)</label><input type="text" id="eventLocation" class="form-control" placeholder="e.g. SAR"></div>
            <div class="form-group" id="periodGroup"><label>Period</label><select id="eventPeriod" class="form-control"><option value="preflight">Preflight</option><option value="morning">Morning Period</option><option value="m5" id="opt-m5">M4.5</option><option value="other">Other</option></select></div>
            <div class="form-group" id="customTimeCheckContainer"><label style="font-weight: normal; cursor:pointer;"><input type="checkbox" id="customTimeCheck"> Enable Custom Time</label></div>
            <div class="form-group" id="timeframeGroup" style="display:none;"><label>Timeframe</label><div class="time-inputs"><input type="time" id="startTime" class="form-control"><span style="align-self:center;">to</span><input type="time" id="endTime" class="form-control"></div></div>
            <div class="form-group"><label>Class Attendance</label><div class="checkbox-group"><label class="checkbox-all"><input type="checkbox" id="allClassesCheck"> All</label><label><input type="checkbox" value="26" class="class-check"> 26</label><label><input type="checkbox" value="27" class="class-check"> 27</label><label><input type="checkbox" value="28" class="class-check"> 28</label><label><input type="checkbox" value="29" class="class-check"> 29</label></div></div>
            <div class="form-group"><label>Notes</label><textarea id="eventNotes" class="form-control" placeholder="Optional details..."></textarea></div>
            <div class="modal-footer">
                <label class="mandatory-toggle"><input type="checkbox" id="mandatoryCheck" checked> Mandatory</label>
                <div class="modal-actions" style="margin-top: 0;">
                    <button id="cancelBtn" class="btn-cancel">Cancel</button>
                    <button id="saveEventBtn" class="btn-save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dayViewModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal-btn" id="closeDayView">&times;</button>
            <div class="day-view-header">
                <div class="header-text-group"><div class="day-view-date" id="dayViewDateDisplay">Date</div><div class="day-view-type" id="dayViewTypeDisplay">M1</div></div>
                <div class="day-view-edit-controls" id="dayViewEditControls">
                    <button id="dayViewAddBtn" class="day-view-add-btn-rect">+ Add Event</button>
                    <div id="standardControls">
                        <label class="toggle-item label-ssoc"><input type="checkbox" id="ssocCheck"> SSoC</label>
                        <label class="toggle-item label-noschool"><input type="checkbox" id="noSchoolCheck"> No School</label>
                    </div>
                    <div id="saturdayControls" style="display:none;">
                        <label class="toggle-item" style="color: #666;"><input type="checkbox" id="silverCheck"> Silver Saturday</label>
                    </div>
                </div>
            </div>
            <div id="dayViewList" class="day-view-list"></div>
        </div>
    </div>

    <script src="schedule-data.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCyoUxG8Qfc6g5kwgqRK0Q2J0k1tXtQeVs",
            authDomain: "cs40-calendar.firebaseapp.com",
            projectId: "cs40-calendar",
            storageBucket: "cs40-calendar.firebasestorage.app",
            messagingSenderId: "661443751516",
            appId: "1:661443751516:web:ddee708ab5a1014cadc099"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global Variables
        let currentDate = new Date();
        let events = [];
        let noSchoolDays = [];
        let silverDays = [];
        const PIN_CODE = "2640";
        let isEditMode = false;
        let currentDayViewKey = null; 
        let currentView = 'month';
        let editingEventId = null;
        
        const filterState = { classes: [], mandatoryOnly: false };

        // --- DOM Elements ---
        const els = {};
        ['monthYear','calendarGrid','prevBtn','nextBtn','weekViewBtn','mainHeaderTitle','mainHeaderLogo',
         'headerActionsLeft','headerActionsRight','calendarNavHeader','cleanModeLegend','addEventBtn','editModeBtn',
         'eventModal','modalTitle','cancelBtn','saveEventBtn','eventDate','eventName','eventLocation',
         'eventPeriod','eventNotes','opt-m5','periodGroup','timeframeGroup','startTime','endTime',
         'customTimeCheck','customTimeCheckContainer','allClassesCheck','dayViewModal','closeDayView',
         'dayViewDateDisplay','dayViewTypeDisplay','dayViewList','dayViewAddBtn','dayViewEditControls',
         'ssocCheck','noSchoolCheck', 'pinModal', 'pinInput', 'cancelPinBtn', 'submitPinBtn',
         'mandatoryCheck', 'standardControls', 'saturdayControls', 'silverCheck',
         'filterBtn', 'filterModal', 'filterMandatoryCheck', 'clearFiltersBtn', 'closeFilterBtn'
        ].forEach(id => els[id] = document.getElementById(id));
        
        const classChecks = document.querySelectorAll('.class-check');
        const filterClassChecks = document.querySelectorAll('.filter-class-check');

        // --- FIREBASE DATA ---
        async function loadData() {
            try {
                const eventsSnapshot = await getDocs(collection(db, "events"));
                events = [];
                eventsSnapshot.forEach((doc) => events.push({ ...doc.data(), id: doc.id }));

                const noSchoolSnapshot = await getDocs(collection(db, "noSchoolDays"));
                noSchoolDays = [];
                noSchoolSnapshot.forEach((doc) => noSchoolDays.push(doc.id));

                const silverSnapshot = await getDocs(collection(db, "silverDays"));
                silverDays = [];
                silverSnapshot.forEach((doc) => silverDays.push(doc.id));

                renderCalendar();
            } catch (e) { console.error(e); alert("Data load error: " + e.message); }
        }

        // --- CALENDAR LOGIC ---
        function getFormattedDate(dateObj) {
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getDayType(dateStr) {
            if (typeof academicSchedule !== 'undefined' && academicSchedule[dateStr]) return academicSchedule[dateStr];
            return "";
        }
        
        function isNoSchoolDay(dateStr) { return noSchoolDays.includes(dateStr); }
        function isWeekendOrNoSchool(dateStr) {
            const d = new Date(dateStr + 'T12:00:00');
            return (d.getDay() === 0 || d.getDay() === 6) || isNoSchoolDay(dateStr);
        }

        function getChipBackground(classes) {
            if (!classes || classes.length === 0 || classes.length === 4) return 'black';
            const colors = { '26': '#d9534f', '27': '#FFD700', '28': '#003087', '29': '#C0C0C0' };
            if (classes.length === 1) return colors[classes[0]] || 'black';
            const sortedClasses = [...classes].sort();
            const segmentSize = 100 / sortedClasses.length;
            let gradientParts = [];
            sortedClasses.forEach((cls, index) => {
                const color = colors[cls];
                const start = index * segmentSize;
                const end = (index + 1) * segmentSize;
                gradientParts.push(`${color} ${start}% ${end}%`);
            });
            return `linear-gradient(to right, ${gradientParts.join(', ')})`;
        }

        // --- FILTERING HELPER ---
        function getFilteredEvents() {
            return events.filter(evt => {
                if (filterState.mandatoryOnly && !evt.mandatory) return false;
                if (filterState.classes.length > 0) {
                    if (!evt.classes || evt.classes.length === 0) return true;
                    const hasMatch = evt.classes.some(c => filterState.classes.includes(c));
                    if (!hasMatch) return false;
                }
                return true;
            });
        }

        function renderCalendar() {
            if (currentView === 'month') { renderMonthView(); } else { renderWeekView(); }
        }

        function renderMonthView() {
            els.mainHeaderTitle.innerText = "CS40 Calendar";
            const todayStr = getFormattedDate(new Date());
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            els.monthYear.innerText = `${monthNames[month]} ${year}`;
            els.calendarGrid.innerHTML = "";
            ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].forEach(day => {
                const h = document.createElement('div'); h.className = 'grid-header-cell'; h.innerText = day; els.calendarGrid.appendChild(h);
            });

            const firstDayIndex = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevLastDay = new Date(year, month, 0).getDate();

            for (let x = firstDayIndex; x > 0; x--) {
                const c = document.createElement('div'); c.className = 'day-cell inactive';
                c.innerHTML = `<span class="date-number">${prevLastDay - x + 1}</span>`; els.calendarGrid.appendChild(c);
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const c = document.createElement('div'); c.className = 'day-cell';
                const dateKey = getFormattedDate(new Date(year, month, i));
                buildDayCellContent(c, dateKey, i);
                if (dateKey === todayStr) c.querySelector('.date-number').classList.add('current-day');
                els.calendarGrid.appendChild(c);
            }
            renderEventsOnGrid();
        }

        function renderWeekView() {
            const todayStr = getFormattedDate(new Date());
            const d = new Date(currentDate);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const startOfWeek = new Date(d.setDate(diff));
            const endOfWeek = new Date(d.setDate(diff + 6));
            
            const options = { month: 'short', day: 'numeric' };
            els.mainHeaderTitle.innerText = `Week of ${startOfWeek.toLocaleDateString('en-US', options)} - ${endOfWeek.toLocaleDateString('en-US', { ...options, year: 'numeric'})}`;
            
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            els.monthYear.innerText = `${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getFullYear()}`;

            els.calendarGrid.innerHTML = "";
            ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].forEach(dayName => {
                const h = document.createElement('div'); h.className = 'grid-header-cell'; h.innerText = dayName; els.calendarGrid.appendChild(h);
            });

            let loopDate = new Date(startOfWeek);
            for (let i = 0; i < 7; i++) {
                const c = document.createElement('div'); c.className = 'day-cell week-view';
                const dateKey = getFormattedDate(loopDate);
                const dayNum = loopDate.getDate();
                buildDayCellContent(c, dateKey, dayNum);
                if (dateKey === todayStr) c.querySelector('.date-number').classList.add('current-day');
                els.calendarGrid.appendChild(c);
                loopDate.setDate(loopDate.getDate() + 1);
            }
            renderEventsOnGrid();
        }

        function buildDayCellContent(dayCell, dateKey, dayNum) {
            const dayType = getDayType(dateKey);
            const isNoSchool = isWeekendOrNoSchool(dateKey);
            let htmlContent = `<span class="date-number">${dayNum}</span><div class="day-type">${dayType}</div>`;
            
            const d = new Date(dateKey + 'T12:00:00');
            if (d.getDay() === 6) { 
                const isSilver = silverDays.includes(dateKey);
                htmlContent += `<div class="weekend-label">${isSilver ? "Silver Weekend" : "Blue Weekend"}</div>`;
            }

            htmlContent += `<div class="day-content">`;
            if (isNoSchool) {
                htmlContent += `<div class="day-section" style="border:none; height:100%; display:flex; flex-direction:column; justify-content:center;" id="cell-${dateKey}-weekend"></div>`;
            } else if (dayType.startsWith('T')) {
                htmlContent += `<div class="day-section" id="cell-${dateKey}-preflight" data-label="Preflight"></div><div class="day-section" id="cell-${dateKey}-morning" data-label="AM"></div><div class="day-section" id="cell-${dateKey}-other" data-label="Other"></div>`;
            } else {
                htmlContent += `<div class="day-section" id="cell-${dateKey}-preflight" data-label="Preflight"></div><div class="day-section" id="cell-${dateKey}-morning" data-label="AM"></div><div class="day-section" id="cell-${dateKey}-m5" data-label="M4.5"></div><div class="day-section" id="cell-${dateKey}-other" data-label="Other"></div>`;
            }
            htmlContent += `</div>`;
            dayCell.innerHTML = htmlContent;
            dayCell.addEventListener('click', () => openDayView(dateKey, dayType));
        }

        function renderEventsOnGrid() {
            const eventsByTarget = {};
            const filteredEvents = getFilteredEvents(); 

            filteredEvents.forEach(evt => {
                let targetId;
                const isNoSchool = isWeekendOrNoSchool(evt.date);
                if (isNoSchool) {
                    targetId = `cell-${evt.date}-weekend`;
                } else {
                    targetId = `cell-${evt.date}-${evt.period}`;
                }
                if (!eventsByTarget[targetId]) eventsByTarget[targetId] = [];
                eventsByTarget[targetId].push(evt);
            });

            Object.keys(eventsByTarget).forEach(targetId => {
                const targetEl = document.getElementById(targetId);
                if (!targetEl) return;
                const evts = eventsByTarget[targetId];
                
                // SORTING LOGIC
                evts.sort((a, b) => {
                    if (a.name === "Special Schedule of Calls") return -1;
                    if (b.name === "Special Schedule of Calls") return 1;
                    const tA = a.startTime || "99:99";
                    const tB = b.startTime || "99:99";
                    return tA.localeCompare(tB);
                });

                if (currentView === 'month' && evts.length > 2) {
                    const chip = createEventChip(evts[0]);
                    targetEl.appendChild(chip);
                    const dotDiv = document.createElement('div');
                    dotDiv.className = 'more-events-indicator';
                    dotDiv.innerText = '...';
                    targetEl.appendChild(dotDiv);
                } else {
                    evts.forEach(evt => { targetEl.appendChild(createEventChip(evt)); });
                }
            });
        }

        function createEventChip(evt) {
            const chip = document.createElement('div');
            chip.className = 'event-chip';
            if (evt.name === "Special Schedule of Calls") {
                chip.style.background = "white"; chip.style.color = "black"; chip.style.textAlign = "center"; chip.style.border = "1px solid #ccc"; chip.style.fontWeight = "bold"; 
                chip.style.padding = "1px 4px"; // Fixed Sizing
                chip.innerText = evt.name; return chip;
            }
            if (currentView === 'month') {
                chip.innerText = evt.name;
            } else {
                let content = `<span style="font-weight:bold; display:block;">${evt.name}</span>`;
                if (evt.startTime) content += `<span style="display:block; font-size:0.85em; opacity:0.9;">${evt.startTime}${evt.endTime ? '-' + evt.endTime : ''}</span>`;
                if (evt.location) content += `<span style="display:block; font-size:0.85em; font-style:italic; opacity:0.9;">${evt.location}</span>`;
                chip.innerHTML = content;
            }
            chip.style.background = getChipBackground(evt.classes);
            return chip;
        }

        // --- FILTER HANDLERS ---
        els.filterBtn.onclick = () => { els.filterModal.style.display = 'flex'; };
        els.closeFilterBtn.onclick = () => { els.filterModal.style.display = 'none'; };
        els.clearFiltersBtn.onclick = () => {
            filterClassChecks.forEach(cb => cb.checked = false);
            els.filterMandatoryCheck.checked = false;
            updateFilters();
        };

        function updateFilters() {
            filterState.classes = [];
            filterClassChecks.forEach(cb => { if (cb.checked) filterState.classes.push(cb.value); });
            filterState.mandatoryOnly = els.filterMandatoryCheck.checked;
            
            if(filterState.classes.length > 0 || filterState.mandatoryOnly) {
                els.filterBtn.classList.add('active-filter');
            } else {
                els.filterBtn.classList.remove('active-filter');
            }
            renderCalendar();
        }

        filterClassChecks.forEach(cb => cb.addEventListener('change', updateFilters));
        els.filterMandatoryCheck.addEventListener('change', updateFilters);


        // --- UI HANDLERS ---
        els.editModeBtn.addEventListener('click', () => {
            if (!isEditMode) { els.pinInput.value = ""; els.pinModal.style.display = 'flex'; els.pinInput.focus(); } 
            else { isEditMode = false; updateEditModeUI(); }
        });

        function checkPin() {
            if (els.pinInput.value === PIN_CODE) { isEditMode = true; updateEditModeUI(); els.pinModal.style.display = 'none'; } 
            else { alert("Incorrect PIN."); els.pinInput.value = ""; els.pinInput.focus(); }
        }
        els.submitPinBtn.onclick = checkPin;
        els.cancelPinBtn.onclick = () => els.pinModal.style.display = 'none';
        els.pinInput.onkeypress = (e) => { if(e.key === 'Enter') checkPin(); };

        function updateEditModeUI() {
            if (isEditMode) { 
                els.editModeBtn.innerText = "Exit Edit Mode"; 
                els.addEventBtn.style.display = 'block'; 
            } else { 
                els.editModeBtn.innerText = "Edit Mode"; 
                els.addEventBtn.style.display = 'none'; 
            }
            if (els.dayViewModal.style.display === 'flex' && currentDayViewKey) {
                const type = getDayType(currentDayViewKey); openDayView(currentDayViewKey, type);
            }
        }

        function openDayView(dateKey, dayType) {
            currentDayViewKey = dateKey;
            els.dayViewDateDisplay.innerText = new Date(dateKey + 'T12:00:00').toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            els.dayViewTypeDisplay.innerText = dayType ? `Day: ${dayType}` : "No M/T Type";
            els.dayViewList.innerHTML = ""; 

            if (isEditMode) {
                els.dayViewEditControls.style.display = 'flex';
                const d = new Date(dateKey + 'T12:00:00');
                if (d.getDay() === 6) { // Saturday
                    els.standardControls.style.display = 'none';
                    els.saturdayControls.style.display = 'flex';
                    els.silverCheck.checked = silverDays.includes(dateKey);
                } else {
                    els.standardControls.style.display = 'flex';
                    els.saturdayControls.style.display = 'none';
                    els.noSchoolCheck.checked = isNoSchoolDay(dateKey);
                    const existingSSOC = events.find(e => e.date === dateKey && e.name === "Special Schedule of Calls");
                    els.ssocCheck.checked = !!existingSSOC;
                }
                els.dayViewAddBtn.onclick = () => { els.dayViewModal.style.display = 'none'; openAddModal(dateKey); };
                
                els.noSchoolCheck.onclick = async () => {
                    try { if (els.noSchoolCheck.checked) { await setDoc(doc(db, "noSchoolDays", dateKey), { active: true }); noSchoolDays.push(dateKey); } else { await deleteDoc(doc(db, "noSchoolDays", dateKey)); noSchoolDays = noSchoolDays.filter(d => d !== dateKey); } renderCalendar(); } catch(e) { alert("Error: " + e.message); }
                };
                els.ssocCheck.onclick = async () => {
                    try { if (els.ssocCheck.checked) { await addDoc(collection(db, "events"), { date: dateKey, name: "Special Schedule of Calls", period: "other", classes: [] }); } else { const ssocEvents = events.filter(e => e.date === dateKey && e.name === "Special Schedule of Calls"); for (const evt of ssocEvents) await deleteDoc(doc(db, "events", evt.id)); } await loadData(); } catch(e) { alert("Error: " + e.message); }
                };
                els.silverCheck.onclick = async () => {
                    try { if (els.silverCheck.checked) { await setDoc(doc(db, "silverDays", dateKey), { active: true }); silverDays.push(dateKey); } else { await deleteDoc(doc(db, "silverDays", dateKey)); silverDays = silverDays.filter(d => d !== dateKey); } renderCalendar(); } catch(e) { alert("Error: " + e.message); }
                };
            } else { els.dayViewEditControls.style.display = 'none'; }

            // Filter the Day View List too
            const dayEvents = getFilteredEvents().filter(e => e.date === dateKey);
            const isNoSchool = isWeekendOrNoSchool(dateKey);

            // SAME SORTING LOGIC FOR DAY VIEW
            dayEvents.sort((a, b) => {
                if (a.name === "Special Schedule of Calls") return -1;
                if (b.name === "Special Schedule of Calls") return 1;
                const tA = a.startTime || "99:99";
                const tB = b.startTime || "99:99";
                return tA.localeCompare(tB);
            });

            if (dayEvents.length === 0) els.dayViewList.innerHTML = "<p style='color:#777; font-style:italic;'>No events.</p>";
            else {
                dayEvents.forEach(evt => {
                    const item = document.createElement('div'); item.className = 'day-view-item';
                    const periodNames = { 'preflight': 'Preflight', 'morning': 'Morning Period', 'm5': 'M4.5', 'other': 'Other' };
                    let attendanceStr = (!evt.classes || evt.classes.length === 0 || evt.classes.length === 4) ? 'All' : evt.classes.join(', ');
                    let timeDisplay = evt.startTime ? (evt.startTime + (evt.endTime ? ` - ${evt.endTime}` : '')) : (periodNames[evt.period] || 'Other');
                    let locationHtml = evt.location ? `<p><strong>Location:</strong> ${evt.location}</p>` : "";
                    
                    // REMOVED (Mandatory) Text from display
                    let leftCol = `<div class="day-view-info"><h4>${evt.name}</h4><p><strong>Time:</strong> ${timeDisplay}</p>${locationHtml}<p><strong>Attendance:</strong> ${attendanceStr}</p>`;
                    
                    if (isEditMode) leftCol += `<button class="action-btn-sm edit-btn" style="display:inline-block;">Edit</button><button class="action-btn-sm delete-btn" style="display:inline-block;">Delete</button>`;
                    leftCol += `</div>`;
                    let rightCol = (evt.notes && evt.notes.trim()) ? `<div class="day-view-notes"><strong>Notes:</strong>${evt.notes}</div>` : "";
                    item.innerHTML = leftCol + rightCol;

                    if (isEditMode) {
                        item.querySelector('.edit-btn').onclick = () => { els.dayViewModal.style.display = 'none'; openAddModal(dateKey, evt); };
                        item.querySelector('.delete-btn').onclick = async () => { if(confirm("Delete?")) { await deleteDoc(doc(db, "events", evt.id)); await loadData(); openDayView(dateKey, dayType); } };
                    }
                    els.dayViewList.appendChild(item);
                });
            }
            els.dayViewModal.style.display = 'flex';
        }

        function openAddModal(dateStr, eventToEdit = null) {
            els.eventName.value = ''; els.eventLocation.value = ''; els.startTime.value = ''; els.endTime.value = ''; els.eventNotes.value = '';
            els.allClassesCheck.checked = false; classChecks.forEach(cb => cb.checked = false); els.customTimeCheck.checked = false; els.mandatoryCheck.checked = true;
            
            if (eventToEdit) {
                editingEventId = eventToEdit.id;
                els.modalTitle.innerText = "Edit Event"; els.saveEventBtn.innerText = "Update Event";
                els.eventDate.value = eventToEdit.date; els.eventName.value = eventToEdit.name; els.eventLocation.value = eventToEdit.location || ''; els.eventNotes.value = eventToEdit.notes || '';
                if (eventToEdit.hasOwnProperty('mandatory')) els.mandatoryCheck.checked = eventToEdit.mandatory;
                if(eventToEdit.classes) { eventToEdit.classes.forEach(cls => { const cb = document.querySelector(`.class-check[value="${cls}"]`); if(cb) cb.checked = true; }); if(eventToEdit.classes.length === 4) els.allClassesCheck.checked = true; }
                const isNoSchool = isWeekendOrNoSchool(eventToEdit.date);
                if (isNoSchool) { els.startTime.value = eventToEdit.startTime || ''; els.endTime.value = eventToEdit.endTime || ''; } 
                else { els.eventPeriod.value = eventToEdit.period; if (eventToEdit.period !== 'other' && (eventToEdit.startTime || eventToEdit.endTime)) els.customTimeCheck.checked = true; els.startTime.value = eventToEdit.startTime || ''; els.endTime.value = eventToEdit.endTime || ''; }
                updateModalOptions(eventToEdit.date);
            } else { editingEventId = null; els.modalTitle.innerText = "Add Event"; els.saveEventBtn.innerText = "Save"; els.eventDate.value = dateStr; updateModalOptions(dateStr); }
            els.eventModal.style.display = 'flex';
        }

        function updateModalOptions(dateStr) {
            const isNoSchool = isWeekendOrNoSchool(dateStr);
            const selectedPeriod = els.eventPeriod.value;
            if (isNoSchool) { els.periodGroup.style.display = 'none'; els.timeframeGroup.style.display = 'block'; els.customTimeCheckContainer.style.display = 'none'; } 
            else { els.periodGroup.style.display = 'block'; if (selectedPeriod === 'other') { els.customTimeCheckContainer.style.display = 'none'; els.timeframeGroup.style.display = 'block'; } else { els.customTimeCheckContainer.style.display = 'block'; els.timeframeGroup.style.display = els.customTimeCheck.checked ? 'block' : 'none'; }
                const dayType = getDayType(dateStr); if (dayType.startsWith('T')) { els['opt-m5'].style.display = 'none'; if (els.eventPeriod.value === 'm5') els.eventPeriod.value = 'preflight'; } else { els['opt-m5'].style.display = 'block'; } }
        }

        els.customTimeCheck.addEventListener('change', () => updateModalOptions(els.eventDate.value));
        els.eventPeriod.addEventListener('change', () => updateModalOptions(els.eventDate.value));
        els.eventDate.addEventListener('change', (e) => updateModalOptions(e.target.value));
        els.allClassesCheck.addEventListener('change', (e) => { classChecks.forEach(cb => cb.checked = e.target.checked); });
        classChecks.forEach(cb => { cb.addEventListener('change', () => { els.allClassesCheck.checked = Array.from(classChecks).every(c => c.checked); }); });
        els.cancelBtn.onclick = () => els.eventModal.style.display = 'none';
        els.closeDayView.onclick = () => els.dayViewModal.style.display = 'none';
        window.onclick = (e) => { if (e.target == els.eventModal) els.eventModal.style.display = "none"; if (e.target == els.dayViewModal) els.dayViewModal.style.display = "none"; if (e.target == els.pinModal) els.pinModal.style.display = "none"; if (e.target == els.filterModal) els.filterModal.style.display = "none"; };
        els.mainHeaderLogo.addEventListener('dblclick', () => { els.headerActionsLeft.classList.toggle('force-hide'); els.headerActionsRight.classList.toggle('force-hide'); els.calendarNavHeader.classList.toggle('hidden'); if (els.headerActionsRight.classList.contains('force-hide')) els.cleanModeLegend.classList.add('force-show-flex'); else els.cleanModeLegend.classList.remove('force-show-flex'); });
        els.weekViewBtn.addEventListener('click', () => { currentView = (currentView === 'month') ? 'week' : 'month'; els.weekViewBtn.innerText = (currentView === 'month') ? "Week View" : "Month View"; renderCalendar(); });
        els.prevBtn.addEventListener('click', () => { if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() - 1); else currentDate.setDate(currentDate.getDate() - 7); renderCalendar(); });
        els.nextBtn.addEventListener('click', () => { if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() + 1); else currentDate.setDate(currentDate.getDate() + 7); renderCalendar(); });
        els.addEventBtn.addEventListener('click', () => { openAddModal(getFormattedDate(new Date())); });

        els.saveEventBtn.addEventListener('click', async () => {
            const date = els.eventDate.value; const name = els.eventName.value; if (!date || !name) { alert("Please fill in Date and Event Name"); return; }
            const selectedClasses = []; document.querySelectorAll('.class-check:checked').forEach(cb => selectedClasses.push(cb.value));
            const isNoSchool = isWeekendOrNoSchool(date); const hasTimeframe = isNoSchool || els.eventPeriod.value === 'other' || els.customTimeCheck.checked;
            const eventData = { date, name, location: els.eventLocation.value, notes: els.eventNotes.value, period: isNoSchool ? 'weekend' : els.eventPeriod.value, startTime: hasTimeframe ? els.startTime.value : null, endTime: hasTimeframe ? els.endTime.value : null, classes: selectedClasses, mandatory: els.mandatoryCheck.checked };
            els.saveEventBtn.innerText = "Saving...";
            try { if (editingEventId) await updateDoc(doc(db, "events", editingEventId), eventData); else await addDoc(collection(db, "events"), eventData); await loadData(); els.eventModal.style.display = 'none'; } catch (e) { alert("Error saving event: " + e.message); } finally { els.saveEventBtn.innerText = "Save"; }
        });

        loadData();
    </script>
</body>
</html>